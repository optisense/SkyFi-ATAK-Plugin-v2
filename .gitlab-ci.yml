# TAK.gov GitLab CI/CD Pipeline for ATAK Plugin
# Based on working HelloWorld sample configuration

default:
  image: ${TAK_REGISTRY_HOST}/devsecops/android-builder-image:17-${ANDROID_BUILDER_TAG}

include:
  - project: 'devsecops/gitlab-ci-common'
    ref: master
    file: '/template/build_and_sign.yml'
  - project: 'devsecops/gitlab-ci-common'
    ref: master
    file: '/template/artifactory_token_service.yml'

variables:
  GIT_DEPTH: 1
  GIT_SUBMODULE_STRATEGY: none  # No submodules needed
  ATAK_CI: "1"
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=false"
  GRADLE_USER_HOME: "${CI_PROJECT_DIR}/.gradle"
  # Fallback credentials if CI variables not set
  TAKREPO_USER: "jfuginay"
  TAKREPO_PASSWORD: "glpat-EfxW36mJhsG7c_bJ3C7k"

stages:
  - build
  - test
  - package
  - production
  
# Cache Gradle dependencies
cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - .gradle/
    - build/
    - app/build/

# Base job for building plugin using Artifactory token
.assemblePlugin:
  extends: .artifactory_service_create_token
  stage: build
  before_script:
    - chmod +x gradlew
    # Debug: Check if credentials are available
    - echo "ARTIFACTORY_URL_APK=${ARTIFACTORY_URL_APK:-not_set}"
    - echo "GITLAB_USER_EMAIL=${GITLAB_USER_EMAIL:-not_set}"
    - echo "CI_JOB_ARTIFACTORY_TOKEN is ${CI_JOB_ARTIFACTORY_TOKEN:+set}"
    # Create local.properties with credentials
    - |
      cat > local.properties << EOF
      sdk.dir=${ANDROID_SDK_ROOT:-/opt/android-sdk}
      takrepo.url=${ARTIFACTORY_URL_APK:-https://artifacts.tak.gov/artifactory/maven}
      takrepo.user=${GITLAB_USER_EMAIL:-jfuginay}
      takrepo.password=${CI_JOB_ARTIFACTORY_TOKEN:-glpat-EfxW36mJhsG7c_bJ3C7k}
      EOF
  script:
    - ./gradlew -Pci --console=plain -Ptakrepo.url=${ARTIFACTORY_URL_APK:-https://artifacts.tak.gov/artifactory/maven} -Ptakrepo.user=${GITLAB_USER_EMAIL:-jfuginay} -Ptakrepo.password=${CI_JOB_ARTIFACTORY_TOKEN:-glpat-EfxW36mJhsG7c_bJ3C7k} ${ASSEMBLE_GRADLE_TASK}
  artifacts:
    expire_in: 720h
    paths:
      - app/build/outputs/

# Build variants - matching HelloWorld pattern
assembleMilSdk:
  extends: .assemblePlugin
  variables:
    ASSEMBLE_GRADLE_TASK: assembleMilDebug

assembleMilOdk:
  extends: .assemblePlugin
  variables:
    ASSEMBLE_GRADLE_TASK: assembleMilRelease
  
assembleCivSdk:
  extends: .assemblePlugin
  variables:
    ASSEMBLE_GRADLE_TASK: assembleCivDebug

assembleCivOdk:
  extends: .assemblePlugin
  variables:
    ASSEMBLE_GRADLE_TASK: assembleCivRelease

# Production build with signing
assembleProduction:
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^maintenance/'
      when: always
    - if: '$CI_COMMIT_BRANCH !~ /^maintenance/'
      when: manual
      allow_failure: true 
  stage: production
  extends: .build_and_sign_jdk17

# Test job
testRelease:
  extends: .artifactory_service_create_token
  stage: test
  script:
    - chmod +x gradlew
    - ./gradlew -Pci --console=plain -Ptakrepo.url=$ARTIFACTORY_URL_APK -Ptakrepo.user=$GITLAB_USER_EMAIL -Ptakrepo.password=${CI_JOB_ARTIFACTORY_TOKEN} :app:testCivRelease
  when: manual

